# ブートローダ

Circleプロジェクトはシリアルブートローダを提供しており、これを利用することで
開発のスピードアップや快適な開発を行うことができます。このブートローダは
David Welch氏による有名なブートローダを応用しています。

ブートローダは次の手順で使用します。

1. シリアルUSBアダプタ（3.3Vレベル）を、片方はRaspberry PiコンピュータのGPIO14/15
（BCM番号）に、もう片方は開発機に接続する必要があります。

2. 開発機には、python3インタプリタ（python3-pyserialモジュールを含む）がインストール
されている必要があります。また、端末プログラム"putty"が必要になる場合もあります。

3. CircleのルートディレクトリにあるConfig.mkに以下の行を追加します。

    ```
    SERIALPORT = /dev/ttyUSB0	（シリアルUSBアダプタのデバイス）
    FLASHBAUD = 115200		（アプリケーションをロードするボーレート）
    USERBAUD = 115200		（アプリケーションが使用するボーレート）
    ```

FLASHBAUDを上げることでローディングを非常に高速化することができます。どのボーレートが
使用可能かはシリアルアダプタに依存します。一般的な値は460800、921600またはそれ以上です。

USERBAUDはアプリケーション自身がシリアルインターフェイスを使用して通信を行う場合に
使用するボーレートです。

4. アプリケーションで使用するCircleプロジェクトのライブラリはREADME.mdファイルに
記述されているように"./makeall"を使用して個別にビルドする必要があります。

5. Raspberry Piをブートローダモードで起動するSDカードを用意する必要があります。
`boot/`サブディレクトリに移動して以下を実行します。

    ```
    make all
    ```

完了後、`boot/`のファイルをSDカードにコピーします（"config.txt"はAArch64の場合のみコピー）。
SDカードにはFATパーティションがなければなりません。Config.mkのFLASHBAUDパラメータを変更した
場合はその都度、この手順を繰り返す必要があることに注意してください。ビルドされたブート
ローダは指定のボーレート専用だからです。SDカードを開発機に接続したRaspberry Piにセットし
電源を入れます。

6. シェルでアプリケーション(またはサンプルプログラム)のサブディレクトリに移動して
以下を入力するとブートローダが起動します。

    ```
    make flash
    ```

7. アプリケーションがシリアルインタフェースを使用している場合は、シェルから直接、
端末プログラム "putty" を起動することができます。"flash"した時と同じように
"make monitor"と入力すると正しい通信パラメータでputtyが起動します。

8. もう一度、開発サイクルを開始するには、Raspberry Piの電源を入れ直し、再度ビルド
した後にもう一度 "make flash" を実行します。

## 新しいFlashツール "Flashy" の使い方

上記の手順は、従来のpython3ベースのフラッシュツールとブートローダを使用した
デバイスへの書き込みについて説明しました。改善された機能を提供する新しい
フラッシュツールとブートローダが導入されました。

* 新しいフラッシュツールはブートローダからのackメッセージを待ち、デバイスの
準備ができたことを確認します。デバイスの準備ができない場合はリセットするまで
待機します。

* 新しいブートローダはチェックサムを実行し、転送時のエラーを報告するようになり
信頼性が向上しました。

* 新しい「高速転送モード」は、16進エンコードデータではなくバイナリを送信することにより
転送レートを実質上、2倍にします。高速モードでは、RPi 2で2M Baud (旧フラッシャーでは
4M Baud相当)、RPi 3では3M Baud (6M相当) で処理できます。

* 新しいフラッシュツールは、マジックリブート文字列を送信し、デバイスが準備完了になるのを
待ってから転送を開始することができます。これは、悲観的な遅延でデバイスの準備完了を望むよりも
高速になります。

* 新しいフラッシュツールはフラッシュ後に自動的にモニタモードに切り替え（必要ならばボー
レートを切り替えて）書き込んだプログラムの出力を見ることができます。

* 転送キャンセルや転送失敗から回復するためにブートローダをリセットする機能があります。

* "go delay"機能の導入。goコマンドを受け取ってからユーザプログラムを起動するまでの間
  ブートローダがストールすることで遅延を発生させます。これは、デバッグログの最初期部分を
  見る必要があり、モニタプログラムが起動するまでに時間がかかりすぎる場合に使用できます。

新しいフラッシュツールはJavaScriptで書かれており、NodeJSのインストールが必要です。
以下の手順で使用します。

1. NodeJSのインストールを確認します。

2. `tools/flashy`サブフォルダに移動して`npm install`を実行し、必要なシリアルポートモジュールを
インストールします。

3. 古いバージョンのブートローダを使用している場合は、最新バージョンをリビルドしてSDカードに
コピーします（これはオプションです。新しいフラッシュスクリプトは古いブートローダで動作するから
です。ただし、ほとんどの新機能は動作しません）。

4. Config.mkで変数`USEFLASHY`をシリアルポートの設定と一緒に設定します。

    ```
    USEFLASHY = 1
    REBOOTMAGIC = <magicstring>
    FLASHYFLAGS = <flashy scriptの他のコマンドライン引数>
    SERIALPORT = /dev/ttyUSB0
    FLASHBAUD = 115200
    USERBAUD = 115200
    ```

5. 以前と同様にデバイスをフラッシュします。

    ```
    make flash
    ```

6. デバイスの準備ができていればすぐに転送が始まりますが、そうでない場合は
デバイスの電源を入れるかリセットするまで"waiting for device"メッセージが表示されます。

フラッシュツールは手動で起動することもできます。次のように入力します。

```
node tools/flashy/flashy.js /dev/ttyUSB0 kernel7.hex --flashBaud:2000000
```

または、makeスクリプトに追加の引数を渡してください。

```
make flash FLASHYFLAGS=--godelay:500
```

すべてのコマンドライン引数を表示するには、次のように--helpをつけてスクリプトを実行します。

```
node tools/flashy/flashy.js --help
```

WSLでこのツールを使うための詳細は[Windows build instructions](windows-build.txt)を参照してください。
