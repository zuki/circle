# マルチコアサポート

Raspberry Pi 2/3/4に搭載されているCPU　Cortex-A7/-A53/-A72は同じコアを4つ
搭載しています。Circleではそれらを使用して4つのスレッドを同時に実行することが
できます。ユーザは特定の作業タスクをコアに割り当てる責任があります。ただし、
すべてのペリフェラルのIRQ（とカーネルタイマーハンドラやUSB完了ルーチンなどの
IRQによって呼び出されるコールバック）はコア0上で処理されます。

これまでの（シングルコア）Circleアプリケーションは`CKernel`クラスで実装されて
いました（初期化を含む）。マルチコアアプリケーションでは少なくとも2つの
アプリケーションクラスを使用するようになります。`CKernel`はコア0上で実行され、
ほとんど初期化のみを行います。主なアプリケーション機能は`CMultiCoreSupport`を
継承したユーザ定義クラスで実装されます。`CMultiCoreSupport::Run()`がコア番号
（0～3）をパラメータとして各コアで呼び出されます。この番号を使うことで、
それぞれのコアで実行されるべき関数を分岐させることができます。

`CMultiCoreSupport`を使用するには`include/circle/sysconfig.h`で
`ARM_ALLOW_MULTI_CORE`を定義する必要があります。この定義により
コア0（シングルコア）しか使用しない場合、実行速度が少し遅くなることがあります。

システムの初期化はコア0でのみ実行されます。マルチコアサポート
（CMultiCoreSupportの派生クラス）は`CKernel::Initialize()`の最後で初期化する
必要があります。

次のクラスは（初期化後に）複数のコアで同時に使用できます。

* CScreenDevice
* CSerialDevice
* CLogger
* CTimer
* USB
* FAT file system (割り込みコンテキストからは使用不可)
* CDeviceNameService (割り込みコンテキストからは使用不可)
* CBcmPropertyTags (割り込みコンテキストからは使用不可)
* CBcmMailBox (割り込みコンテキストからは使用不可)
* CI2CMaster (割り込みコンテキストからは使用不可)
* CGPIOPin (複数のインスタンスを同時に使用可。ただし、CGPIOPinインスタンスへのアクセスは一度に1つのコアだけ)
* CPWMOutput
* CBcmRandomNumberGenerator

上記以外のクラスを同時に使用する場合は、ユーザが同期させる必要があります。
シングルコアアプリケーションでの同期は、通常、`EnterCritical()`で行われて
いました。今後は`CSpinLock`クラスが使用されることになります。`EnterCritical()`は
あるコアでローカルに実行されているスレッドがIRQ（タイミング目的など）や
プロセッサ間割り込み（IPI）で中断されないようにする場合にのみ使用します。

コア0はペリフェラルの割り込みを処理するため、すべてのセカンダリコアが停止する
まで停止されません。これは`halt()`を使用するのであればCircleによって保証されます。
システムパニック状態になった場合、すべてのコアが停止されます。これは
`CMultiCoreSupport::IPIHandler()`をオーバーロードすることで変更することができます。

Circleのインターラプト転送用のUSBフレームスケジューラは非常にシンプルであることに
注意してください。（ストレージデバイスやEthernetデバイスを使用したことで）大量の
USBバルクトラフィックが生成された場合、インターラプト転送を使用しているデバイス
（キーボードやマウスなど）に応答が非常に遅くなるなどの問題が発生する可能性があります。
このような問題が判明した場合はプログラムフローで時々短い遅延を継続的に実行する
ことでUSBにリラックスする時間を与える必要があります。

協調型非プリエンプティブスケジューラは1つのコアで複数のスレッドを動作させることを
想定しています。一度に複数のコアで使用することはできず、常にコア0上で実行する必要が
あります。
